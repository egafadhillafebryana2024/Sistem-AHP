<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPK & Laporan Proses Pengeringan</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Library untuk PDF & Grafik -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Library untuk Ikon -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .page-content { display: none; }
        .page-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .main-container {
            width: 100%;
            max-width: 100%; 
            background: #fff;
            display: flex;
            flex-direction: column;
            min-height: 90vh;
            border-radius: 1.5rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        @media (min-width: 768px) {
            .main-container {
                max-width: 500px;
                margin: 0 auto;
            }
        }

        .main-content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 70px; /* Space for nav-bar */
        }
        .bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 65px;
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-radius: 0 0 1.5rem 1.5rem;
        }
        .nav-item.active svg { color: #4f46e5; }
        .nav-item.active p { color: #4f46e5; font-weight: 600; }

        /* Styling for AHP comparison table */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem; /* text-sm */
        }
        .comparison-table th {
            background-color: #f3f4f6; /* bg-gray-100 */
            font-weight: 600; /* font-semibold */
            color: #4b5563; /* text-gray-700 */
        }
        .comparison-table td select {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.25rem; /* rounded-md */
            background-color: #ffffff; /* bg-white */
            font-size: 0.875rem;
        }
        .comparison-table td.diagonal {
            background-color: #e0e7ff; /* bg-indigo-100 */
            font-weight: 700; /* font-bold */
        }
        .comparison-table td.locked {
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #6b7280; /* text-gray-500 */
            font-weight: 500;
        }
    </style>
</head>
<body>
<div class="main-container relative">
    <!-- Main scrollable content -->
    <div class="main-content-area">
        <!-- Login Page -->
        <div id="login" class="page-content active p-6 md:p-8">
            <div class="text-center mb-8">
                <img src="https://companieslogo.com/img/orig/CPIN.JK_BIG-222f07df.png" alt="Logo PT Charoen Pokphand Indonesia" class="mx-auto mb-4 w-40 h-auto object-contain">
                <h2 class="text-lg font-semibold text-gray-800">PT CHAROEN POKPHAND INDONESIA</h2>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Login</h1>
            <div class="space-y-4 mt-4">
                 <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <button onclick="login()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Login</button>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page-content p-6">
            <h2 class="text-xl font-bold text-gray-800">Dashboard</h2>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-xs text-blue-800 font-medium">Total Proses Hari Ini</p>
                    <p id="db-total-proses" class="text-3xl font-bold text-blue-900">0</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-xs text-green-800 font-medium">Bahan Bakar Paling Efisien</p>
                    <p id="db-bahan-efisien" class="text-lg font-bold text-green-900">-</p>
                </div>
            </div>
            <div class="mt-6">
                <h3 class="text-md font-semibold text-gray-700">Grafik Suhu Rata-rata (°C)</h3>
                <canvas id="suhuChart" class="mt-2"></canvas>
            </div>
            <div class="mt-6">
                <h3 class="text-md font-semibold text-gray-700">Grafik Biaya (Rp)</h3>
                <canvas id="biayaChart" class="mt-2"></canvas>
            </div>
            <div class="mt-6">
                 <button onclick="showPage('inputDataAHP')" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700">Lakukan Analisis AHP</button>
            </div>
        </div>

        <!-- Input Data Proses Page -->
        <div id="inputProses" class="page-content p-6">
            <div class="flex items-center mb-6">
                <button onclick="navigate('dashboard')" class="p-1 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left"></i></button>
                <h2 class="text-xl font-bold text-gray-800 ml-4">Input Data Pengeringan</h2>
            </div>
            <form id="prosesForm" class="space-y-4">
                <input type="hidden" id="prosesId" value="">
                <div>
                    <label for="prosesBahanBakar" class="block text-sm font-medium text-gray-700">Jenis Bahan Bakar</label>
                    <select id="prosesBahanBakar" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md"></select>
                </div>
                 <div>
                    <label for="prosesSuhu" class="block text-sm font-medium text-gray-700">Suhu Pembakaran (°C)</label>
                    <input type="number" id="prosesSuhu" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="prosesBiaya" class="block text-sm font-medium text-gray-700">Biaya (Rp)</label>
                    <input type="number" id="prosesBiaya" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" required>
                </div>
                 <div>
                    <label for="prosesKonsumsi" class="block text-sm font-medium text-gray-700">Konsumsi Bahan Bakar (Kg)</label>
                    <input type="number" id="prosesKonsumsi" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="prosesWaktu" class="block text-sm font-medium text-gray-700">Waktu Pengeringan (Jam)</label>
                    <input type="number" id="prosesWaktu" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="prosesOutput" class="block text-sm font-medium text-gray-700">Total Output (Kg Jagung Kering)</label>
                    <input type="number" id="prosesOutput" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" required>
                </div>
                <button id="simpanBtn" onclick="simpanDataProses()" type="button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg mt-4">Simpan Data</button>
            </form>
        </div>

        <!-- Laporan Proses Page -->
        <div id="laporanProses" class="page-content p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Laporan Proses</h2>
            <div id="laporanContainer" class="space-y-3">
                <!-- Report data will be displayed here -->
            </div>
             <p id="laporanKosong" class="text-center text-gray-500 mt-10 hidden">Belum ada data laporan.</p>
        </div>

        <!-- AHP Pages (separated flow) -->
        <!-- Input Data AHP Page -->
        <div id="inputDataAHP" class="page-content p-6">
            <div class="flex items-center mb-6">
                 <button onclick="navigate('dashboard')" class="p-1 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left"></i></button>
                <h2 class="text-xl font-bold text-gray-800 ml-4">Analisis AHP</h2>
            </div>

            <!-- Criteria Settings Section -->
            <div class="mb-6 p-4 border rounded-lg bg-indigo-50">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Kriteria</h3>
                <div id="criteriaContainer" class="space-y-2">
                    <!-- Criteria will be loaded here and editable -->
                </div>
                <button onclick="addCriterion()" class="mt-3 text-sm text-indigo-600 font-medium">+ Tambah Kriteria</button>
            </div>

            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Alternatif</h3>
                <div id="alternativesContainer" class="space-y-2">
                    <!-- Alternatives will be loaded here and editable -->
                </div>
                <button onclick="addAlternative()" class="mt-3 text-sm text-indigo-600 font-medium">+ Tambah Alternatif</button>
            </div>
            <button onclick="generateComparisonPage()" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg">Mulai Perbandingan</button>
        </div>

        <!-- Pairwise Comparison Page -->
        <div id="comparisonPage" class="page-content p-6">
            <div class="flex items-center mb-6">
                 <button onclick="showPage('inputDataAHP')" class="p-1 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left"></i></button>
                <h2 class="text-xl font-bold text-gray-800 ml-4">Perbandingan AHP</h2>
            </div>
             <p id="comparisonHint" class="text-sm text-gray-500 -mt-4 mb-6">
                Isi semua perbandingan secara manual. Nilai 1 berarti sama penting.
             </p>
            <div id="comparisonFormsContainer" class="space-y-8"></div>
            <button onclick="calculateAHP()" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg mt-6">Hitung Hasil AHP</button>
        </div>

        <!-- AHP Results Page -->
        <div id="hasilAHP" class="page-content p-6">
            <div class="flex items-center mb-6">
                 <button onclick="showPage('inputDataAHP')" class="p-1 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left"></i></button>
                <h2 class="text-xl font-bold text-gray-800 ml-4">Hasil Perhitungan AHP</h2>
            </div>
            <div id="resultsToPrint" class="bg-gray-50 p-4 rounded-lg">
                <div id="resultsContainer" class="space-y-6"></div>
            </div>
            <button id="downloadPdfBtn" onclick="downloadResultsAsPDF()" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg mt-6">Unduh Hasil (PDF)</button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div id="bottomNavContainer" class="bottom-nav hidden">
        <div id="nav-dashboard" onclick="navigate('dashboard')" class="nav-item text-center text-gray-500 p-2 cursor-pointer">
            <i data-lucide="layout-dashboard" class="mx-auto"></i>
            <p class="text-xs mt-1">Dashboard</p>
        </div>
        <div id="nav-inputProses" onclick="navigate('inputProses')" class="nav-item text-center text-gray-500 p-2 cursor-pointer">
            <i data-lucide="file-plus-2" class="mx-auto"></i>
            <p class="text-xs mt-1">Input</p>
        </div>
        <div id="nav-laporanProses" onclick="navigate('laporanProses')" class="nav-item text-center text-gray-500 p-2 cursor-pointer">
            <i data-lucide="bar-chart-3" class="mx-auto"></i>
            <p class="text-xs mt-1">Laporan</p>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-4">
        <h3 id="modalTitle" class="text-lg font-bold mb-2"></h3>
        <p id="modalMessage" class="text-sm text-gray-600"></p>
        <div class="mt-4 text-right">
            <button onclick="closeModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm">Tutup</button>
        </div>
    </div>
</div>

<script>
// --- CONFIGURATION AND STATE ---
window.jsPDF = window.jspdf.jsPDF;
let criteria = ["Efisiensi Energi", "Biaya Pengeringan", "Suhu Pembakaran", "Ketersediaan Bahan"];
let alternatives = []; // Will be populated from UI input
let prosesPengeringanData = [ // Initial dummy data for dashboard
    { id: 1, tanggal: new Date(2025, 6, 1).toLocaleDateString('id-ID'), bahanBakar: "Bonggol Jagung", suhu: 80, waktu: 5, biaya: 150000, konsumsi: 20, output: 100 },
    { id: 2, tanggal: new Date(2025, 6, 2).toLocaleDateString('id-ID'), bahanBakar: "Woodchips", suhu: 75, waktu: 6, biaya: 180000, konsumsi: 25, output: 90 },
    { id: 3, tanggal: new Date(2025, 6, 3).toLocaleDateString('id-ID'), bahanBakar: "Cangkang Sawit", suhu: 85, waktu: 4, biaya: 120000, konsumsi: 18, output: 110 },
    { id: 4, tanggal: new Date(2025, 6, 4).toLocaleDateString('id-ID'), bahanBakar: "Bonggol Jagung", suhu: 82, waktu: 5.5, biaya: 160000, konsumsi: 22, output: 105 },
    { id: 5, tanggal: new Date(2025, 6, 5).toLocaleDateString('id-ID'), bahanBakar: "Woodchips", suhu: 78, waktu: 6.5, biaya: 190000, konsumsi: 27, output: 95 },
    { id: 6, tanggal: new Date().toLocaleDateString('id-ID'), bahanBakar: "Bonggol Jagung", suhu: 88, waktu: 4.5, biaya: 140000, konsumsi: 19, output: 115 }
];
let suhuChart, biayaChart;
const RI = { 1: 0, 2: 0, 3: 0.58, 4: 0.9, 5: 1.12, 6: 1.24, 7: 1.32, 8: 1.41, 9: 1.45, 10: 1.49 };

// Saaty Scale for comparison dropdowns
const saatyScale = [
    { value: 1/9, text: '1/9' }, { value: 1/8, text: '1/8' }, { value: 1/7, text: '1/7' },
    { value: 1/6, text: '1/6' }, { value: 1/5, text: '1/5' }, { value: 1/4, text: '1/4' },
    { value: 1/3, text: '1/3' }, { value: 1/2, text: '1/2' }, { value: 1, text: '1' },
    { value: 2, text: '2' }, { value: 3, text: '3' }, { value: 4, text: '4' },
    { value: 5, text: '5' }, { value: 6, text: '6' }, { value: 7, text: '7' },
    { value: 8, text: '8' }, { value: 9, text: '9' }
];

// --- INIT & NAVIGATION FUNCTIONS ---
document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    initializeAHPInputs();
    renderCriteriaInputs();
    updateDashboard();
});

function login() {
    document.getElementById('login').classList.remove('active');
    document.getElementById('dashboard').classList.add('active');
    document.getElementById('bottomNavContainer').classList.remove('hidden');
    navigate('dashboard');
}

function showPage(pageId) {
    document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
    const targetPage = document.getElementById(pageId);
    if(targetPage) {
        targetPage.classList.add('active');
        const mainPages = ['dashboard', 'inputProses', 'laporanProses'];
        if (mainPages.includes(pageId)) {
            updateNavUI(pageId);
        }
    }
}

function navigate(pageId) {
    showPage(pageId);
    if (pageId === 'inputProses') {
        document.getElementById('prosesForm').reset();
        document.getElementById('prosesId').value = '';
        document.getElementById('simpanBtn').textContent = 'Simpan Data';
        populateBahanBakarDropdown();
    }
    if (pageId === 'laporanProses') generateAndShowReport();
    if (pageId === 'dashboard') updateDashboard();
    if (pageId === 'inputDataAHP') {
        renderCriteriaInputs();
        initializeAHPInputs();
    }
}

function updateNavUI(activePage) {
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    const activeItem = document.getElementById(`nav-${activePage}`);
    if(activeItem) activeItem.classList.add('active');
}

function showMessage(title, message, isError = false, isConfirm = false, onConfirm = null) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').textContent = message;
    document.getElementById('modalTitle').className = isError ? 'text-lg font-bold text-red-600 mb-2' : 'text-lg font-bold text-green-600 mb-2';

    const modalFooter = document.getElementById('messageModal').querySelector('.mt-4.text-right');
    modalFooter.innerHTML = ''; 

    if (isConfirm) {
        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = 'Ya, Hapus';
        confirmBtn.className = 'px-4 py-2 bg-red-600 text-white rounded-lg text-sm mr-2';
        confirmBtn.onclick = onConfirm;
        modalFooter.appendChild(confirmBtn);

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Batal';
        cancelBtn.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded-lg text-sm';
        cancelBtn.onclick = closeModal;
        modalFooter.appendChild(cancelBtn);
    } else {
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Tutup';
        closeBtn.className = 'px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm';
        closeBtn.onclick = closeModal;
        modalFooter.appendChild(closeBtn);
    }

    document.getElementById('messageModal').classList.remove('hidden');
    document.getElementById('messageModal').classList.add('flex');
}

function closeModal() {
    document.getElementById('messageModal').classList.add('hidden');
    document.getElementById('messageModal').classList.remove('flex');
}

// --- DASHBOARD ---
function updateDashboard() {
    const today = new Date().toLocaleDateString('id-ID');
    const prosesHariIni = prosesPengeringanData.filter(p => p.tanggal === today);
    document.getElementById('db-total-proses').textContent = prosesHariIni.length;

    if (prosesPengeringanData.length > 0) {
        const dataWithEfficiency = prosesPengeringanData.map(p => ({
            ...p,
            costPerKg: p.output > 0 ? p.biaya / p.output : Infinity
        }));
        const palingEfisien = dataWithEfficiency.reduce((p, c) => (p.costPerKg < c.costPerKg) ? p : c);
        document.getElementById('db-bahan-efisien').textContent = palingEfisien.bahanBakar;
    } else {
        document.getElementById('db-bahan-efisien').textContent = 'Belum ada data';
    }

    const labels = prosesPengeringanData.map(p => p.tanggal);
    const suhuData = prosesPengeringanData.map(p => p.suhu);
    const biayaData = prosesPengeringanData.map(p => p.biaya);

    const chartOptions = {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
            x: { title: { display: true, text: 'Tanggal Proses' } },
            y: { beginAtZero: true }
        }
    };

    if (suhuChart) suhuChart.destroy();
    suhuChart = new Chart(document.getElementById('suhuChart'), {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'Suhu', data: suhuData, borderColor: '#3b82f6', tension: 0.4,
                backgroundColor: 'rgba(59, 130, 246, 0.2)', fill: true
            }]
        },
        options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, title: { display: true, text: 'Suhu (°C)' } } } }
    });

    if (biayaChart) biayaChart.destroy();
    biayaChart = new Chart(document.getElementById('biayaChart'), {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'Biaya', data: biayaData, borderColor: '#10b981', tension: 0.4,
                backgroundColor: 'rgba(16, 185, 129, 0.2)', fill: true
            }]
        },
        options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, title: { display: true, text: 'Biaya (Rp)' } } } }
    });
}

// --- PROCESS DATA MANAGEMENT ---
function populateBahanBakarDropdown() {
    const select = document.getElementById('prosesBahanBakar');
    select.innerHTML = '';
    alternatives.forEach(alt => {
        const option = document.createElement('option');
        option.value = alt;
        option.textContent = alt;
        select.appendChild(option);
    });
}

function simpanDataProses() {
    const form = document.getElementById('prosesForm');
    if (!form.checkValidity()) {
        showMessage('Error', 'Mohon isi semua field.', true);
        return;
    }
    const prosesId = document.getElementById('prosesId').value;
    const formData = {
        bahanBakar: document.getElementById('prosesBahanBakar').value,
        suhu: parseFloat(document.getElementById('prosesSuhu').value),
        waktu: parseFloat(document.getElementById('prosesWaktu').value),
        biaya: parseFloat(document.getElementById('prosesBiaya').value),
        konsumsi: parseFloat(document.getElementById('prosesKonsumsi').value),
        output: parseFloat(document.getElementById('prosesOutput').value)
    };

    if (prosesId) {
        const index = prosesPengeringanData.findIndex(p => p.id == prosesId);
        if (index > -1) {
            prosesPengeringanData[index] = { ...prosesPengeringanData[index], ...formData };
            showMessage('Sukses', 'Data proses berhasil diperbarui.');
        }
    } else {
        const newProses = { id: Date.now(), tanggal: new Date().toLocaleDateString('id-ID'), ...formData };
        prosesPengeringanData.push(newProses);
        showMessage('Sukses', 'Data proses berhasil disimpan.');
    }
    form.reset();
    document.getElementById('prosesId').value = '';
    document.getElementById('simpanBtn').textContent = 'Simpan Data';
    navigate('dashboard');
}

function editProses(id) {
    const data = prosesPengeringanData.find(p => p.id === id);
    if (!data) return;
    showPage('inputProses');
    document.getElementById('prosesId').value = data.id;
    populateBahanBakarDropdown();
    document.getElementById('prosesBahanBakar').value = data.bahanBakar;
    document.getElementById('prosesSuhu').value = data.suhu;
    document.getElementById('prosesWaktu').value = data.waktu;
    document.getElementById('prosesBiaya').value = data.biaya;
    document.getElementById('prosesKonsumsi').value = data.konsumsi;
    document.getElementById('prosesOutput').value = data.output;
    document.getElementById('simpanBtn').textContent = 'Update Data';
}

function hapusProses(id) {
    const confirmDelete = () => {
        prosesPengeringanData = prosesPengeringanData.filter(p => p.id !== id);
        generateAndShowReport();
        closeModal();
    };
    showMessage('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus data ini?', false, true, confirmDelete);
}

// --- REPORT ---
function generateAndShowReport() {
    const container = document.getElementById('laporanContainer');
    const placeholder = document.getElementById('laporanKosong');
    container.innerHTML = '';
    if (prosesPengeringanData.length === 0) {
        placeholder.classList.remove('hidden');
        return;
    }
    placeholder.classList.add('hidden');
    prosesPengeringanData.forEach(p => {
        const card = document.createElement('div');
        card.className = "bg-white border rounded-lg p-4 space-y-2";
        card.innerHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-bold text-lg">${p.bahanBakar}</p>
                    <p class="text-xs text-gray-500">${p.tanggal}</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="editProses(${p.id})" class="p-1 text-blue-600"><i data-lucide="file-pen-line"></i></button>
                    <button onclick="hapusProses(${p.id})" class="p-1 text-red-600"><i data-lucide="trash-2"></i></button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-sm pt-2">
                <p><strong class="font-medium">Waktu:</strong> ${p.waktu} jam</p>
                <p><strong class="font-medium">Suhu:</strong> ${p.suhu}°C</p>
                <p><strong class="font-medium">Biaya:</strong> Rp ${p.biaya.toLocaleString('id-ID')}</p>
                <p><strong class="font-medium">Konsumsi:</strong> ${p.konsumsi} Kg</p>
                <p><strong class="font-medium">Output:</strong> ${p.output} Kg</p>
            </div>
        `;
        container.appendChild(card);
    });
    lucide.createIcons();
    showPage('laporanProses');
}

// --- AHP LOGIC ---

function initializeAHPInputs() {
    const defaultAlternatives = ["Cangkang Sawit", "Woodchips", "Bonggol Jagung"];
    const container = document.getElementById('alternativesContainer');
    container.innerHTML = '';
    if (alternatives.length === 0) {
        defaultAlternatives.forEach(alt => addAlternative(alt));
    } else {
        alternatives.forEach(alt => addAlternative(alt));
    }
    updateAlternativesArray();
}

function addAlternative(value = '') {
    const container = document.getElementById('alternativesContainer');
    const div = document.createElement('div');
    div.className = 'flex items-center space-x-2';
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'input-alternatif mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md';
    input.value = value;
    if(!value) input.placeholder = 'Nama Alternatif Baru...';
    input.oninput = updateAlternativesArray;
    const button = document.createElement('button');
    button.innerHTML = '×';
    button.className = 'text-red-500 font-bold text-2xl hover:text-red-700';
    button.onclick = () => {
        div.remove();
        updateAlternativesArray();
    };
    div.appendChild(input);
    div.appendChild(button);
    container.appendChild(div);
    updateAlternativesArray();
}

function updateAlternativesArray() {
    alternatives = Array.from(document.querySelectorAll('#alternativesContainer .input-alternatif'))
                     .map(i => i.value.trim()).filter(Boolean);
}

function renderCriteriaInputs() {
    const container = document.getElementById('criteriaContainer');
    container.innerHTML = '';

    criteria.forEach((crit, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center space-x-2';
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'input-criterion mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md';
        input.value = crit;
        input.oninput = updateCriteriaArray;

        const button = document.createElement('button');
        button.innerHTML = '×';
        button.className = 'text-red-500 font-bold text-2xl hover:text-red-700';
        button.onclick = () => removeCriterion(index);

        div.appendChild(input);
        div.appendChild(button);
        container.appendChild(div);
    });
}

function addCriterion() {
    criteria.push('');
    renderCriteriaInputs();
    document.querySelectorAll('#criteriaContainer .input-criterion:last-child')[0].focus();
}

function removeCriterion(index) {
    if (criteria.length <= 2) {
        showMessage("Error", "Minimal harus ada 2 kriteria.", true);
        return;
    }
    criteria.splice(index, 1);
    renderCriteriaInputs();
}

function updateCriteriaArray() {
    criteria = Array.from(document.querySelectorAll('#criteriaContainer .input-criterion'))
                     .map(i => i.value.trim()).filter(Boolean);
}

function generateComparisonPage() {
    if (alternatives.length < 2 || criteria.length < 2) {
        showMessage("Error", "Mohon masukkan minimal 2 kriteria dan 2 alternatif.", true);
        return;
    }

    const container = document.getElementById('comparisonFormsContainer');
    container.innerHTML = '';

    container.appendChild(createComparisonForm('Kriteria', criteria, 'Perbandingan antar Kriteria'));
    criteria.forEach(criterion => {
        const title = `Perbandingan Alternatif untuk: <span class="font-bold">${criterion}</span>`;
        container.appendChild(createComparisonForm(criterion, alternatives, title));
    });

    initializeAllComparisons();
    showPage('comparisonPage');
}

function createComparisonForm(idPrefix, items, titleText) {
    const formWrapper = document.createElement('div');
    formWrapper.className = "p-4 border rounded-lg bg-gray-50";
    const title = document.createElement('h3');
    title.className = "text-md font-semibold text-gray-700 mb-4";
    title.innerHTML = titleText;
    formWrapper.appendChild(title);

    const table = document.createElement('table');
    table.className = 'comparison-table';
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');

    let headerRow = '<tr><th></th>';
    items.forEach(item => { headerRow += `<th>${item}</th>`; });
    headerRow += '</tr>';
    thead.innerHTML = headerRow;
    table.appendChild(thead);

    items.forEach((rowItem, i) => {
        let rowHTML = `<tr><th>${rowItem}</th>`;
        items.forEach((colItem, j) => {
            const safeIdPrefix = idPrefix.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
            const cellId = `${safeIdPrefix}-cell-${i}-${j}`;
            if (i === j) {
                rowHTML += `<td id="${cellId}" class="diagonal">1</td>`;
            } else if (i < j) {
                let selectHTML = `<select id="${cellId}" class="w-full px-2 py-1 bg-white border border-gray-300 rounded-md text-sm" onchange="updateTableValue(this, '${safeIdPrefix}', ${i}, ${j})">`;
                saatyScale.forEach(opt => {
                    selectHTML += `<option value="${opt.value}" ${opt.value === 1 ? 'selected' : ''}>${opt.text}</option>`;
                });
                selectHTML += '</select>';
                rowHTML += `<td>${selectHTML}</td>`;
            } else {
                rowHTML += `<td id="${cellId}" class="locked">1</td>`;
            }
        });
        rowHTML += '</tr>';
        tbody.innerHTML += rowHTML;
    });
    table.appendChild(tbody);
    formWrapper.appendChild(table);
    
    return formWrapper;
}

function updateTableValue(selectElement, idPrefix, i, j) {
    const value = parseFloat(selectElement.value);
    const reciprocalValue = 1 / value;
    const reciprocalCellId = `${idPrefix}-cell-${j}-${i}`;
    const reciprocalCell = document.getElementById(reciprocalCellId);

    if (reciprocalCell) {
        const reciprocalOption = saatyScale.find(opt => Math.abs(opt.value - reciprocalValue) < 0.0001);
        reciprocalCell.textContent = reciprocalOption ? reciprocalOption.text : reciprocalValue.toFixed(3);
    }
}

function initializeAllComparisons() {
    document.querySelectorAll('#comparisonFormsContainer select').forEach(select => {
        select.value = "1";
        select.dispatchEvent(new Event('change'));
    });
}

function calculateAHP() {
    const criteriaMatrix = buildMatrixFromForm('Kriteria', criteria);
    const criteriaResult = calculateWeightsAndConsistency(criteriaMatrix);
    if (criteriaResult.CR > 0.1) {
        showMessage("Peringatan", `Perbandingan kriteria tidak konsisten (CR = ${criteriaResult.CR.toFixed(3)}). Mohon sesuaikan kembali.`, true);
        return;
    }

    const alternativeResults = {};
    for (const crit of criteria) {
        const altMatrix = buildMatrixFromForm(crit, alternatives);
        const altResult = calculateWeightsAndConsistency(altMatrix);
        if (altResult.CR > 0.1) {
            showMessage("Peringatan", `Perbandingan alternatif untuk "${crit}" tidak konsisten (CR = ${altResult.CR.toFixed(3)}). Mohon sesuaikan kembali.`, true);
        }
        alternativeResults[crit] = altResult;
    }

    const finalScores = alternatives.map((alt, altIdx) => {
        let totalScore = 0;
        criteria.forEach((crit, critIdx) => {
            const criteriaWeight = criteriaResult.weights[critIdx];
            const alternativeWeight = alternativeResults[crit].weights[altIdx];
            totalScore += criteriaWeight * alternativeWeight;
        });
        return { name: alt, score: totalScore };
    });

    const rankedResults = finalScores.sort((a, b) => b.score - a.score);
    displayResultsAHP(rankedResults, criteriaResult);
    showPage('hasilAHP');
}

function buildMatrixFromForm(idPrefix, items) {
    const n = items.length;
    const matrix = Array(n).fill(0).map(() => Array(n).fill(1));

    for (let i = 0; i < n; i++) {
        for (let j = i + 1; j < n; j++) {
            const safeIdPrefix = idPrefix.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
            const elementId = `${safeIdPrefix}-cell-${i}-${j}`;
            const select = document.getElementById(elementId);
            
            let val = 1;
            if (select) {
                val = parseFloat(select.value);
            }

            matrix[i][j] = val;
            matrix[j][i] = 1 / val;
        }
    }
    return matrix;
}

function calculateWeightsAndConsistency(matrix) {
    const n = matrix.length;
    if (n === 0) return { weights: [], CR: 0 };

    const colSums = Array(n).fill(0);
    for (let j = 0; j < n; j++) {
        for (let i = 0; i < n; i++) {
            colSums[j] += matrix[i][j];
        }
    }

    const normMatrix = matrix.map(row => row.map((val, j) => colSums[j] === 0 ? 0 : val / colSums[j]));
    const weights = normMatrix.map(row => row.reduce((a, b) => a + b, 0) / n);

    if (n <= 2) return { weights, CR: 0 };

    const weightedSum = Array(n).fill(0);
    for (let i = 0; i < n; i++) {
        for (let j = 0; j < n; j++) {
            weightedSum[i] += matrix[i][j] * weights[j];
        }
    }

    const lambdaVector = weightedSum.map((val, idx) => weights[idx] === 0 ? 0 : val / weights[idx]);
    const lambdaMax = lambdaVector.reduce((a, b) => a + b, 0) / n;
    const CI = (lambdaMax - n) / (n - 1);
    const CR = CI / RI[n];

    return { weights, CR };
}

function displayResultsAHP(rankedResults, criteriaResult) {
    const container = document.getElementById('resultsContainer');
    const winner = rankedResults[0] ? rankedResults[0].name : 'Tidak ada';
    container.innerHTML = `
        <div>
            <h3 class="text-lg font-semibold text-gray-800">Bobot Kriteria</h3>
            <p class="text-xs text-gray-500 mb-2">Rasio Konsistensi (CR): 
                <span class="${criteriaResult.CR > 0.1 ? 'text-red-500 font-bold' : 'text-green-600'}">
                    ${criteriaResult.CR.toFixed(4)}
                </span>
            </p>
            <div class="bg-white p-3 rounded-md border text-sm space-y-1">
                ${criteria.map((name, i) => `
                    <div class="flex justify-between">
                        <span>${name}</span>
                        <span class="font-medium">${(criteriaResult.weights[i] * 100).toFixed(2)}%</span>
                    </div>
                `).join('')}
            </div>
        </div>
        <div>
            <h3 class="text-lg font-semibold text-gray-800 mt-4">Peringkat Alternatif</h3>
             <div class="bg-white p-3 rounded-md border text-sm space-y-1 mt-2">
                ${rankedResults.map((res, i) => `
                    <div class="flex justify-between items-center py-1 ${i === 0 ? 'font-bold text-green-700 bg-green-50 rounded-md px-2 -mx-2' : ''}">
                        <span>${i + 1}. ${res.name}</span>
                        <span>${res.score.toFixed(4)}</span>
                    </div>
                `).join('')}
            </div>
        </div>
        <div class="mt-4 text-center bg-green-100 p-3 rounded-lg">
            <p class="text-sm text-green-800">Rekomendasi Alternatif Terbaik:</p>
            <p class="font-bold text-xl text-green-800">${winner}</p>
        </div>
    `;
}

// --- DOWNLOAD PDF ---
function downloadResultsAsPDF() {
    const btn = document.getElementById('downloadPdfBtn');
    btn.innerText = 'Mengunduh...';
    btn.disabled = true;
    const element = document.getElementById('resultsToPrint');
    html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const imgWidth = pdfWidth - 20;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let position = 10;
        pdf.setFont('Inter', 'normal');
        pdf.text('Laporan Hasil Analisis AHP', pdfWidth / 2, position, { align: 'center' });
        position += 10;
        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        pdf.save('Hasil-AHP.pdf');
        btn.innerText = 'Unduh Hasil (PDF)';
        btn.disabled = false;
    }).catch(err => {
        showMessage("Error", "Gagal membuat PDF.", true);
        console.error("Error creating PDF:", err);
        btn.innerText = 'Unduh Hasil (PDF)';
        btn.disabled = false;
    });
}
</script>
</body>
</html>
